# 🚀 iFly ナビゲーションデータコンバーター使用ガイド

本ガイドでは、iFly ナビゲーションデータコンバーターの基本的な操作から高度な機能までを詳細に紹介し、Fenix から iFly へのナビゲーションデータ変換をスムーズに完了できるようお手伝いします。

## 🎯 使用前の準備

### 1. ファイル準備チェックリスト

変換を開始する前に、以下のファイルが準備されていることを確認してください。

- ✅ **Fenix ナビゲーションデータベース** (`nd.db3`)
  ```
  場所: %APPDATA%\Microsoft Flight Simulator\Packages\fenix-a320\SimObjects\Airplanes\FenixA320\navdata\nd.db3
  サイズ: 通常 50-200MB
  形式: SQLite データベースファイル
  ```

- ✅ **NAIP 航路データ** (`RTE_SEG.csv`)
  ```
  ソース: 中国民航データサービスウェブサイト
  エンコーディング: UTF-8
  サイズ: 通常 5-20MB
  形式: CSV ファイル、航路区間情報を含む
  ```

- ✅ **iFly 737 MAX 8** がインストールされ、正常に動作すること

### 2. 環境検証

実行環境チェック用スクリプト:
```bash
# Python 環境を検証
python --version  # 3.8 以上が表示されるべきです

# 依存パッケージを検証
python -c "import rich, pandas, pygeomag; print('環境検証通過!')"

# 利用可能なメモリをチェック
python -c "import psutil; print(f'利用可能なメモリ: {psutil.virtual_memory().available // (1024**3)} GB')"
```

## 🖥️ 対話型使用

### コンバーターを起動

```bash
# プロジェクトディレクトリに移動
cd /path/to/ifly-converter

# コンバーターを起動
python main.py
```

### ようこそ画面

コンバーターを起動すると、モダンなウェルカムインターフェースが表示されます:

```
╔═══════════════════════════════════════ 🛩️  航空ナビゲーションデータ変換ツール  ✈️ ═══════════════════════════════════════╗
║                                                                                                          ║
║                                      FenixからiFlyへの航空ナビゲーションデータコンバーター                                       ║
║                                          高品質、モダンな変換体験                                         ║
║                                                                                                          ║
╚═══════════════════════════════════════ Powered by Rich • バージョン 2.0 ═══════════════════════════════════════════╝

🔍 システムチェック...
✅ Python 環境: 3.9.16
✅ 依存パッケージ: 全てインストール済み
✅ 利用可能なメモリ: 8.2 GB
✅ ディスク容量: 125 GB

変換プロセスを開始する準備中...
```

## 📋 変換ステップ詳細

### ステップ 1: Fenix データベースに接続

```
╭─────────────────────────────────────────────── 🔄 ステップ 1/4 ────────────────────────────────────────────────╮
│ Fenix データベースに接続                                                                                        │
│ Fenix A320 ナビゲーションデータベースファイル (nd.db3) を選択してください                                                                │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

Fenix データベースファイルのパスを入力してください: 
```

**入力例:**
```bash
# Windows パス
C:\Users\Username\AppData\Roaming\Microsoft Flight Simulator\Packages\fenix-a320\SimObjects\Airplanes\FenixA320\navdata\nd.db3

# または Enter を押して自動検出を使用
[Enter を押して自動検出を使用]
```

**検証プロセス:**
```
🔍 データベースを検証中...
✅ ファイルが存在し読み取り可能
✅ データベース形式が正しい
✅ 必須テーブルが完全 (11/11)
📊 データ統計:
   • 空港: 15,234 個
   • 滑走路: 28,456 本
   • ウェイポイント: 156,789 個
   • ターミナルプロシージャ: 8,945 個
```

### ステップ 2: CSV ファイルを選択

```
╭─────────────────────────────────────────────── 🔄 ステップ 2/4 ────────────────────────────────────────────────╮
│ NAIP 航路データを選択                                                                                        │
│ 中国民航 RTE_SEG.csv ファイルを選択してください                                                                           │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

CSV ファイルのパスを入力してください:
```

**検証プロセス:**
```
🔍 CSV ファイルを検証中...
✅ ファイルエンコーディング: UTF-8
✅ 形式検証に合格
✅ 必須列が存在
📊 データプレビュー:
   • 総レコード数: 12,456 件
   • 航路数: 345 本
   • 適用範囲: 中国大陸、香港、マカオ
   • データ有効期間: AIRAC 2508
```

### ステップ 3: iFly のインストールを特定

```
╭─────────────────────────────────────────────── 🔄 ステップ 3/4 ────────────────────────────────────────────────╮
│ iFly のインストールを特定                                                                                            │
│ iFly 737 MAX 8 のインストール場所を検索中...                                                                       │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

🔍 一般的なインストール場所をスキャン中...
✅ iFly のインストールを発見: Community\ifly-aircraft-737max8\
📁 インストールパス: C:\Users\Username\AppData\Local\Packages\Microsoft.FlightSimulator_xxx\LocalCache\Packages\Community\ifly-aircraft-737max8\
📋 ディレクトリ構造の検証:
   ✅ Data\navdata\Permanent\
   ✅ Data\navdata\Supplemental\
   ✅ 書き込み権限が正常
```

自動検出が失敗した場合、システムは手動入力を促します:
```
❌ 自動検出に失敗しました
iFly 737 MAX 8 のインストールパスを手動で入力してください:
```

### ステップ 4: 変換オプションを設定

```
╭─────────────────────────────────────────────── 🔄 ステップ 4/4 ────────────────────────────────────────────────╮
│ 変換オプションを設定                                                                                              │
│ ターミナルプロシージャ処理パラメータを設定します                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────────╯

ターミナルプロシージャ ID 開始値 [デフォルト: 1000]:
```

**設定オプションの説明:**
```
📊 ターミナルプロシージャ ID 設定:
   • 開始 ID: 1000 (推奨)
   • 予想使用範囲: 1000-3500
   • 利用可能な ID 総数: 9000
   • 推奨予約: 20% バッファ

⚙️ その他のオプション:
   • 座標精度: 小数点以下 8 桁 (デフォルト)
   • 磁気偏角計算: WMM-2025 モデル
   • AIRAC サイクル: 自動計算
```

## 🔄 変換プロセス

### 設定確認

変換開始前に、システムは完全な設定概要を表示します:

```
┌────────────────────────────────── ✅ 変換設定の確認 ──────────────────────────────────┐
│                                                                                   │
│  📂 データソース設定                                                                     │
│  ├─ Fenix データベース: .../navdata/nd.db3 (142.5 MB)                                  │
│  ├─ NAIP CSV ファイル: .../RTE_SEG.csv (8.2 MB)                                      │
│  └─ iFly インストールパス: .../ifly-aircraft-737max8/                                    │
│                                                                                   │
│  ⚙️ 処理パラメータ                                                                       │
│  ├─ ターミナルプロシージャ開始 ID: 1000                                                          │
│  ├─ 座標精度: 小数点以下 8 桁                                                             │
│  ├─ 磁気偏角モデル: WMM-2025                                                           │
│  └─ AIRAC サイクル: 2508 (自動計算)                                                    │
│                                                                                   │
│  📊 予想処理                                                                       │
│  ├─ ウェイポイント: ~12,456 個                                                            │
│  ├─ ターミナルプロシージャ: ~350 個                                                             │
│  └─ 予想時間: 5-10 分                                                           │
│                                                                                   │
└───────────────────────────────────────────────────────────────────────────────────┘

変換を開始しますか? [Y/n]:
```

### 航路データ処理

```
╭─────────────────────────────────────────── 🛣️ 航路データの処理 ───────────────────────────────────────────╮
│                                                                                                      │
│ NAIP 航路区間データを処理中...                                                                          │
│                                                                                                      │
│ ████████████████████████████████████████ 12,456/12,456 (100%) ⏱️ 0:03:45                         │
│                                                                                                      │
│ 現在処理中: A1 航路 → ZSAM-VOR01 区間                                                                   │
│ 磁気偏角計算: 39.917°N, 116.383°E → +7.2°                                                            │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯

📊 航路処理統計:
✅ 処理成功: 12,456 個のウェイポイント
✅ 磁気偏角計算: 12,456 回 (平均 0.02秒/回)
✅ 出力ファイル: WPNAVRTE.txt (2.3 MB 増加)
⚠️ スキップされたレコード: 23 個 (座標異常)
```

### ターミナルプロシージャ処理

```
╭─────────────────────────────────────────── 🏢 ターミナルプロシージャの処理 ───────────────────────────────────────────╮
│                                                                                                      │
│ ターミナルプロシージャデータを変換中...                                                                              │
│                                                                                                      │
│ ████████████████████████████████████████ 350/350 (100%) ⏱️ 0:02:15                               │
│                                                                                                      │
│ 現在処理中: ZBAA (北京首都) → SID SHUAY1A                                                             │
│ プロシージャタイプ: 標準計器出発方式                                                                           │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯

📊 ターミナルプロシージャ統計:
✅ 処理済み空港: 145 個
✅ SID プロシージャ: 234 個
✅ STAR プロシージャ: 198 個  
✅ アプローチプロシージャ: 312 個
✅ 新規ファイル: 89 個
✅ 更新ファイル: 56 個
```

### AIRAC サイクル管理

```
╭─────────────────────────────────────────── 📅 AIRAC サイクル管理 ──────────────────────────────────────────╮
│                                                                                                      │
│ AIRAC サイクルを計算し設定中...                                                                         │
│                                                                                                      │
│ 🗓️ 計算情報                                                                                          │
│ ├─ 基準日: 2024-01-11 (AIRAC 2401)                                                               │
│ ├─ 現在日: 2024-12-24                                                                             │
│ ├─ 経過日数: 348 日                                                                                  │
│ ├─ 経過サイクル: 12.43 → 12 の完全なサイクル                                                                   │
│ └─ 現在のサイクル: 2508                                                                                    │
│                                                                                                      │
│ 📋 サイクル詳細                                                                                          │
│ ├─ AIRAC 識別子: 2508                                                                                 │
│ ├─ 発効日: 2024-12-19                                                                             │
│ ├─ 失効日: 2025-01-16                                                                             │
│ └─ 残り日数: 23 日                                                                                   │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯

✅ AIRAC ファイルが生成されました: FMC_Ident.txt
```

## ✅ 変換完了

### 成功の概要

```
┌─────────────────────────────────────────── ✅ 変換完了 ───────────────────────────────────────────────┐
│                                                                                                        │
│  🎉 おめでとうございます！ナビゲーションデータの変換が正常に完了しました                                                                          │
│                                                                                                        │
│  📊 処理統計                                                                                            │
│  ├─ 🛣️ 航路データ: 12,456 個のウェイポイント                                                                       │
│  ├─ 🏢 ターミナルプロシージャ: 350 個のプロシージャ (145 個の空港)                                                               │
│  ├─ 📅 AIRAC サイクル: 2508                                                                               │
│  └─ ⏱️ 総所要時間: 6 分 32 秒                                                                             │
│                                                                                                        │
│  📁 出力ファイル                                                                                            │
│  ├─ WPNAVRTE.txt: 航路データ (更新済み) (+2.3 MB)                                                                  │
│  ├─ FMC_Ident.txt: AIRAC 識別ファイル                                                                     │
│  ├─ Supplemental: 89 個の新規プロシージャファイル                                                                      │
│  └─ 変換ログ: converter.log                                                                           │
│                                                                                                        │
│  🔄 次のステップの推奨事項                                                                                          │
│  1. Microsoft Flight Simulator を再起動します                                                                   │
│  2. iFly 737 MAX 8 をロードします                                                                               │
│  3. FMC で新しい航路とプロシージャを検証します                                                                        │
│  4. 復元できるようにバックアップファイルを保存します                                                                               │
│                                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### ファイル位置の説明

変換完了後、ファイルは以下の場所に配置されます:

```
📁 iFly ナビゲーションデータディレクトリ:
Community\ifly-aircraft-737max8\Data\navdata\

├── Permanent\
│   ├── WPNAVRTE.txt        # 航路データ (更新済み)
│   └── その他のオリジナルファイル...
│
├── Supplemental\
│   ├── ZBAA\              # 北京首都空港
│   │   ├── SID\           # 標準計器出発方式
│   │   ├── STAR\          # 標準ターミナル到着方式
│   │   └── APP\           # アプローチプロシージャ
│   ├── ZSPD\              # 上海浦東空港
│   └── ...その他の空港
│
└── FMC_Ident.txt          # AIRAC 識別ファイル
```

## 🧪 変換結果の検証

### 1. ファイル検証

```bash
# ファイルが生成されているかチェック
ls -la "Community\ifly-aircraft-737max8\Data\navdata\"

# ファイルサイズをチェック (変換前より大きいはずです)
du -h "Community\ifly-aircraft-737max8\Data\navdata\Permanent\WPNAVRTE.txt"

# AIRAC 識別子を検証
cat "Community\ifly-aircraft-737max8\Data\navdata\FMC_Ident.txt"
```

### 2. シミュレーター検証

1.  **MSFS を再起動**: シミュレーターを完全に終了し、再起動します
2.  **iFly 737 をロード**: iFly 737 MAX 8 を選択します
3.  **FMC をチェック**:
    ```
    FMC ホームページ → INIT REF → AIRAC サイクルを表示
    以下が表示されるべきです: AIRAC 2508
    ```
4.  **航路をテスト**:
    ```
    ROUTE ページ → 中国の航路を入力 (例: A1, B1)
    ウェイポイントと距離が正しく表示されるべきです
    ```

### 3. 機能テストチェックリスト

- [ ] **AIRAC サイクル表示が正しいこと**
- [ ] **中国航路がロードできること** (A1, B1, G212 など)
- [ ] **空港プロシージャが完全であること** (SID, STAR, APP)
- [ ] **ウェイポイント座標が正確であること**
- [ ] **磁気偏角計算が正しいこと**
- [ ] **FMC ナビゲーションが正常であること**

## 🔧 高度な使い方

### バッチ処理モード

現在のバージョンでは直接バッチ処理をサポートしていませんが、スクリプトで実現できます:

```python
# batch_convert.py
import subprocess
import os

databases = [
    "path/to/fenix_db1.db3",
    "path/to/fenix_db2.db3"
]

csv_file = "path/to/RTE_SEG.csv"

for db in databases:
    print(f"処理データベース: {db}")
    # ここで main.py をコマンドライン引数に対応するように変更する必要があります
    # subprocess.run(["python", "main.py", "--db", db, "--csv", csv_file])
```

### カスタム設定ファイル

`config.json` ファイルを作成して、よく使う設定を保存します:

```json
{
    "default_fenix_path": "C:\\Users\\Username\\AppData\\Roaming\\Microsoft Flight Simulator\\Packages\\fenix-a320\\SimObjects\\Airplanes\\FenixA320\\navdata\\nd.db3",
    "default_csv_path": "D:\\Nav-Data\\RTE_SEG.csv",
    "terminal_id_start": 1500,
    "coordinate_precision": 8,
    "enable_backup": true,
    "backup_directory": "D:\\Nav-Data\\Backups"
}
```

### データ更新フロー

推奨される定期的な更新フロー:

```bash
# 1. 現在のデータをバックアップ
cp -r "Community\ifly-aircraft-737max8\Data\navdata" "backup_$(date +%Y%m%d)"

# 2. 最新の NAIP データをダウンロード
# (公式ウェブサイトから新しい RTE_SEG.csv をダウンロード)

# 3. 最新の Fenix データベースを取得
# (Fenix A320 が最新バージョンに更新されていることを確認)

# 4. コンバーターを実行
python main.py

# 5. 結果を検証
# (シミュレーターで新しいデータをテスト)
```

## ⚠️ 注意事項

### 重要事項

1.  **データバックアップ**: 変換前に必ずオリジナルの iFly ナビゲーションデータをバックアップしてください
2.  **バージョン互換性**: Fenix A320 および iFly 737 MAX 8 の最新バージョンを使用していることを確認してください
3.  **有効期間**: AIRAC データは 28 日ごとに更新することを推奨します
4.  **検証テスト**: 変換後、主要な航路でテスト飛行を行ってください

### パフォーマンス最適化

1.  **SSD の使用**: データファイルを SSD に配置して処理速度を向上させます
2.  **ウイルス対策ソフトを一時停止**: 一時的にリアルタイムスキャンをオフにして、ファイルアクセス競合を回避します
3.  **十分なメモリ**: 少なくとも 4GB の利用可能なメモリがあることを確認します
4.  **安定した電源**: UPS を使用するか、電源が安定していることを確認します

### トラブルシューティング

変換プロセス中に問題が発生した場合:

1.  **ログを確認**: `converter.log` ファイルのエラー情報を確認します
2.  **操作を再試行**: 一部のネットワークまたはファイルアクセス問題は一時的な場合があります
3.  **キャッシュをクリア**: 一時ファイルを削除してから再試行します
4.  **設定をダウングレード**: メモリ不足の場合、バッチ処理サイズを減らすことができます

---

**学習完了おめでとうございます！** 🎉 

これで iFly ナビゲーションデータコンバーターの完全な使用方法を習得しました。問題が発生した場合は、[トラブルシューティングガイド](../troubleshooting.md) または [よくある質問](../faq.md) を参照してください。

フライトをお楽しみください！✈️